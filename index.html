<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Éö„Éº„Ç∏</title>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: #f5f5f5;
      padding: 40px;
      text-align: center;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 10px;
      font-size: 26px;
    }
    p.description {
      color: #555;
      margin-bottom: 25px;
    }
    input {
      width: 80%;
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    button {
      padding: 12px 25px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #aaa;
    }
    #status {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>„Ç≠„Éº„ÉØ„Éº„Éâ„Éû„ÉÉ„ÉÅ„É≥„Ç∞</h1>
  <p class="description">„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶ÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>

  <input id="keyword" type="text" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
  <br>
  <button id="accessBtn">ÈÄÅ‰ø°</button>

  <p id="status"></p>
</div>

<script>
  // Firebase Ë®≠ÂÆö
  const firebaseConfig = {
    apiKey: "AIzaSyDN0Bpaa_80Q34nc5Yfn9NzVa1OkdO6Iz0",
    authDomain: "project-5040932402734173095.firebaseapp.com",
    projectId: "project-5040932402734173095",
    storageBucket: "project-5040932402734173095.firebasestorage.app",
    messagingSenderId: "985201726384",
    appId: "1:985201726384:web:6295b669cc4a8a7626fc75"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const btn = document.getElementById("accessBtn");
  const statusEl = document.getElementById("status");
  const keywordInput = document.getElementById("keyword");

  // Á´ØÊú´„Åî„Å®„ÅÆID
  let myId = localStorage.getItem("myUserId");
  if (!myId) {
    myId = Math.random().toString(36).substring(2);
    localStorage.setItem("myUserId", myId);
  }

  btn.addEventListener("click", async () => {
    const text = keywordInput.value.trim();

    // üî• ‚ë†„Äå„Åä„Å®„Åó„Å†„Åæ„Äç„Å™„ÇâÂç≥ 3.html „Å∏
    if (text === "„Åä„Å®„Åó„Å†„Åæ") {
      window.location.href = "3.html";
      return;
    }

    // üî• ‚ë°„Äå„Åæ„Éº„Åò„ÇÉ„Çì„Äç‰ª•Â§ñ„ÅØ„Ç®„É©„Éº
    if (text !== "„Åæ„Éº„Åò„ÇÉ„Çì") {
      statusEl.textContent = "„Ç≠„Éº„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô";
      return;
    }

    // üî• ‚ë¢ „Åì„Åì„Åã„ÇâÂæìÊù•„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞Âá¶ÁêÜ
    btn.disabled = true;
    keywordInput.disabled = true;

    const ref = db.collection("access").doc("counter");
    const now = Date.now();
    let myWindowStart = null;

    await db.runTransaction(async (transaction) => {
      const doc = await transaction.get(ref);

      let windowStart;
      let users;

      if (!doc.exists) {
        windowStart = now;
        users = [myId];
      } else {
        const data = doc.data();
        windowStart = data.windowStart;
        users = data.users || [];

        if (now - windowStart >= 10000) {
          windowStart = now;
          users = [myId];
        } else {
          if (!users.includes(myId)) {
            users.push(myId);
          }
        }
      }

      myWindowStart = windowStart;

      transaction.set(ref, {
        windowStart: windowStart,
        users: users
      });
    });

    // üî• „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ôºà5ÁßíË°®Á§∫Ôºâ
    let remaining = Math.max(0, 5 - Math.floor((Date.now() - myWindowStart) / 1000));
    statusEl.textContent = `5Áßí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ‚Ä¶ (${remaining})`;

    const countdown = setInterval(() => {
      remaining--;
      statusEl.textContent = `5Áßí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ‚Ä¶ (${remaining})`;
      if (remaining <= 0) clearInterval(countdown);
    }, 1000);

    // Âèó‰ªòÁµÇ‰∫Ü„Åæ„ÅßÂæÖ„Å§Ôºà10ÁßíÊû†Ôºâ
    const waitMs = Math.max(0, 10000 - (Date.now() - myWindowStart));
    await new Promise(resolve => setTimeout(resolve, waitMs));

    const finalDoc = await ref.get();
    const finalData = finalDoc.data();

    if (finalData.windowStart !== myWindowStart) {
      window.location.href = "1.html";
      return;
    }

    const finalCount = finalData.users.length;

    if (finalCount === 1) {
      window.location.href = "1.html";
    } else {
      window.location.href = "2.html";
    }
  });
</script>

</body>
</html>
