<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ãƒãƒƒãƒãƒ³ã‚°ãƒšãƒ¼ã‚¸</title>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: #f5f5f5;
      padding: 40px;
      text-align: center;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 10px;
      font-size: 26px;
    }
    p.description {
      color: #555;
      margin-bottom: 25px;
    }
    input {
      width: 80%;
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    button {
      padding: 12px 25px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #aaa;
    }
    #status {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°</h1>
  <p class="description">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>

  <input id="keyword" type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
  <br>
  <button id="accessBtn">é€ä¿¡</button>

  <p id="status"></p>
</div>

<script>
  // Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDN0Bpaa_80Q34nc5Yfn9NzVa1OkdO6Iz0",
    authDomain: "project-5040932402734173095.firebaseapp.com",
    projectId: "project-5040932402734173095",
    storageBucket: "project-5040932402734173095.firebasestorage.app",
    messagingSenderId: "985201726384",
    appId: "1:985201726384:web:6295b669cc4a8a7626fc75"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const btn = document.getElementById("accessBtn");
  const statusEl = document.getElementById("status");
  const keywordInput = document.getElementById("keyword");

  // ç«¯æœ«ã”ã¨ã®ID
  let myId = localStorage.getItem("myUserId");
  if (!myId) {
    myId = Math.random().toString(36).substring(2);
    localStorage.setItem("myUserId", myId);
  }

  btn.addEventListener("click", async () => {
    const text = keywordInput.value.trim();

    // å³æ™‚é·ç§»
    if (text === "ãŠã¨ã—ã ã¾") {
      window.location.href = "3.html";
      return;
    }

    if (text !== "ã¾ãƒ¼ã˜ã‚ƒã‚“") {
      statusEl.textContent = "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
      return;
    }

    btn.disabled = true;
    keywordInput.disabled = true;

    const ref = db.collection("access").doc("counter");
    const now = Date.now();
    let myWindowStart = null;

    await db.runTransaction(async (transaction) => {
      const doc = await transaction.get(ref);

      let windowStart;
      let users;

      if (!doc.exists) {
        windowStart = now;
        users = [myId];
      } else {
        const data = doc.data();

        // ğŸ”¥ ãƒ‡ãƒ¼ã‚¿ç ´æå¯¾ç­–ï¼ˆusers ãŒé…åˆ—ã§ãªã„å ´åˆãƒªã‚»ãƒƒãƒˆï¼‰
        if (typeof data.windowStart !== "number" || !Array.isArray(data.users)) {
          windowStart = now;
          users = [myId];
        } else {
          windowStart = data.windowStart;
          users = data.users;

          // ğŸ”¥ è¿½åŠ ï¼šwindowStart ãŒæœªæ¥ â†’ ãƒªã‚»ãƒƒãƒˆ
          if (data.windowStart > now) {
            windowStart = now;
            users = [myId];
          }
          // ğŸ”¥ 1åˆ†çµŒé â†’ å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
          else if (now - windowStart >= 60000) {
            windowStart = now;
            users = [myId];
          }
          // ğŸ”¥ 5ç§’çµŒé â†’ æ–°ã—ã„æ 
          else if (now - windowStart >= 5000) {
            windowStart = now;
            users = [myId];
          }
          // ğŸ”¥ åŒã˜æ å†…
          else {
            if (!users.includes(myId)) {
              users.push(myId);
            }
          }
        }
      }

      myWindowStart = windowStart;

      transaction.set(ref, {
        windowStart: windowStart,
        users: users
      });
    });

    // ğŸ”¥ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆ5ç§’ï¼‰
    let remaining = Math.max(0, 5 - Math.floor((Date.now() - myWindowStart) / 1000));
    statusEl.textContent = `5ç§’ãŠå¾…ã¡ãã ã•ã„â€¦ (${remaining})`;

    const countdown = setInterval(() => {
      remaining--;
      statusEl.textContent = `5ç§’ãŠå¾…ã¡ãã ã•ã„â€¦ (${remaining})`;
      if (remaining <= 0) clearInterval(countdown);
    }, 1000);

    // ğŸ”¥ 5ç§’å¾…ã¤
    const waitMs = Math.max(0, 5000 - (Date.now() - myWindowStart));
    await new Promise(resolve => setTimeout(resolve, waitMs));

    const finalDoc = await ref.get();
    const finalData = finalDoc.data();

    if (finalData.windowStart !== myWindowStart) {
      window.location.href = "1.html";
      return;
    }

    const finalCount = finalData.users.length;

    // ğŸ”¥ 5äººæœªæº€ â†’ 1.html / 5äººä»¥ä¸Š â†’ 2.html
    if (finalCount < 5) {
      window.location.href = "1.html";
    } else {
      window.location.href = "2.html";
    }
  });
</script>

</body>
</html>
