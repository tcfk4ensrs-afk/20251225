<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Access Test</title>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>アクセスボタン</h1>
<button id="accessBtn">アクセスする</button>
<p id="status"></p>

<script>
  // Firebase 設定（あなたのプロジェクトの値）
  const firebaseConfig = {
    apiKey: "AIzaSyDN0Bpaa_80Q34nc5Yfn9NzVa1OkdO6Iz0",
    authDomain: "project-5040932402734173095.firebaseapp.com",
    projectId: "project-5040932402734173095",
    storageBucket: "project-5040932402734173095.firebasestorage.app",
    messagingSenderId: "985201726384",
    appId: "1:985201726384:web:6295b669cc4a8a7626fc75"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const btn = document.getElementById("accessBtn");
  const statusEl = document.getElementById("status");

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    statusEl.textContent = "マッチング中... 最大10秒お待ちください";

    const ref = db.collection("access").doc("counter");

    // この人が属する「受付グループ」の開始時間を記録する変数
    let myWindowStart = null;

    // 1. トランザクションでカウント＋受付時間を更新
    const now = Date.now();

    await db.runTransaction(async (transaction) => {
      const doc = await transaction.get(ref);

      let windowStart;
      let count;

      if (!doc.exists) {
        // 初回：新しい受付グループを開始
        windowStart = now;
        count = 1;
      } else {
        const data = doc.data();
        windowStart = data.windowStart;
        count = data.count;

        // 以前の受付開始から10秒経っていたら、新しい受付グループを開始
        if (now - windowStart >= 10000) {
          windowStart = now;
          count = 1;
        } else {
          // まだ同じ10秒枠なので人数を増やす
          count = count + 1;
        }
      }

      myWindowStart = windowStart; // このユーザーが属するグループを記録

      transaction.set(ref, {
        windowStart: windowStart,
        count: count
      });
    });

    // 2. その受付グループの締め切り時間まで待つ
    const waitMs = Math.max(0, 10000 - (Date.now() - myWindowStart));
    await new Promise(resolve => setTimeout(resolve, waitMs));

    // 3. 再度ドキュメントを読み取り、「自分のグループ」の最終人数を見る
    const finalDoc = await ref.get();
    if (!finalDoc.exists) {
      // 想定外だけど、一応1人扱いにしておく
      window.location.href = "1.html";
      return;
    }

    const finalData = finalDoc.data();

    // 自分が属している受付グループと同じか確認
    if (finalData.windowStart !== myWindowStart) {
      // もし別のグループに切り替わっていたら、
      // 自分のグループの締め切りは終わっているので、
      // この時点では finalData は新グループ。ここでは1人扱いでもいいし、
      // 安全のため 1.html に飛ばすことにする
      window.location.href = "1.html";
      return;
    }

    const finalCount = finalData.count;

    if (finalCount === 1) {
      // 10秒以内に自分だけ
      window.location.href = "1.html";
    } else {
      // 10秒以内に2人以上いた → 全員2.html
      window.location.href = "2.html";
    }
  });
</script>

</body>
</html>
