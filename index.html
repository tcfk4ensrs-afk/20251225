<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>キーワードマッチング</title>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: linear-gradient(135deg, #fff7c2, #ffe4f2);
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .wrapper {
      width: 100%;
      max-width: 900px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 32px 28px 28px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "Match!";
      position: absolute;
      right: -20px;
      top: -15px;
      font-size: 60px;
      color: rgba(0,0,0,0.05);
      font-weight: 900;
      transform: rotate(15deg);
      pointer-events: none;
    }

    .badge {
      display: inline-block;
      background: #ffcc00;
      color: #5a3b00;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .title-main {
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 0.05em;
      color: #333;
      text-shadow: 0 2px 0 #ffe066;
      margin-bottom: 10px;
    }

    .description {
      font-size: 14px;
      color: #777;
      margin-bottom: 20px;
    }

    .input-box {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border-radius: 10px;
      border: 2px solid #ffd86b;
      background: #fffdf5;
      margin-bottom: 18px;
    }

    .btn-primary {
      background: #ff6b6b;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 12px 26px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 0 #d94c4c;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
    }

    .btn-primary:hover {
      background: #ff8787;
      transform: translateY(1px);
      box-shadow: 0 3px 0 #d94c4c;
    }

    .btn-primary:active {
      transform: translateY(3px);
      box-shadow: 0 1px 0 #b53939;
    }

    #status {
      margin-top: 18px;
      font-size: 16px;
      color: #444;
      min-height: 24px;
    }
  </style>
</head>
<body>

<div class="wrapper">
  <div class="card">

    <div class="badge">MATCHING SYSTEM</div>

    <div class="title-main">キーワードマッチング</div>
    <p class="description">キーワードを入力して開始してください。</p>

    <input id="keyword" class="input-box" type="text" placeholder="キーワードを入力">

    <button id="accessBtn" class="btn-primary">送信</button>

    <p id="status"></p>

  </div>
</div>

<script>
  // Firebase 設定
  const firebaseConfig = {
    apiKey: "AIzaSyDN0Bpaa_80Q34nc5Yfn9NzVa1OkdO6Iz0",
    authDomain: "project-5040932402734173095.firebaseapp.com",
    projectId: "project-5040932402734173095",
    storageBucket: "project-5040932402734173095.firebasestorage.app",
    messagingSenderId: "985201726384",
    appId: "1:985201726384:web:6295b669cc4a8a7626fc75"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const btn = document.getElementById("accessBtn");
  const statusEl = document.getElementById("status");
  const keywordInput = document.getElementById("keyword");

  // 端末ごとのID
  let myId = localStorage.getItem("myUserId");
  if (!myId) {
    myId = Math.random().toString(36).substring(2);
    localStorage.setItem("myUserId", myId);
  }

  btn.addEventListener("click", async () => {
    const text = keywordInput.value.trim();

    // 即時遷移
    if (text === "おとしだま") {
      window.location.href = "start.html";
      return;
    }

    if (text !== "ゆたか") {
      statusEl.textContent = "キーワードが違います";
      return;
    }

    btn.disabled = true;
    keywordInput.disabled = true;

    const ref = db.collection("access").doc("counter");
    const now = Date.now();
    let myWindowStart = null;

    await db.runTransaction(async (transaction) => {
      const doc = await transaction.get(ref);

      let windowStart;
      let users;

      if (!doc.exists) {
        windowStart = now;
        users = [myId];
      } else {
        const data = doc.data();

        if (typeof data.windowStart !== "number" || !Array.isArray(data.users)) {
          windowStart = now;
          users = [myId];
        } else {
          windowStart = data.windowStart;
          users = data.users;

          if (data.windowStart > now) {
            windowStart = now;
            users = [myId];
          }
          else if (now - windowStart >= 20000) {
            windowStart = now;
            users = [myId];
          }
          else if (now - windowStart >= 5000) {
            windowStart = now;
            users = [myId];
          }
          else {
            if (!users.includes(myId)) {
              users.push(myId);
            }
          }
        }
      }

      myWindowStart = windowStart;

      transaction.set(ref, {
        windowStart: windowStart,
        users: users
      });
    });

    // カウントダウン
    let remaining = Math.max(0, 5 - Math.floor((Date.now() - myWindowStart) / 1000));
    statusEl.textContent = `5秒お待ちください… (${remaining})`;

    const countdown = setInterval(() => {
      remaining--;
      statusEl.textContent = `5秒お待ちください… (${remaining})`;
      if (remaining <= 0) clearInterval(countdown);
    }, 1000);

    const waitMs = Math.max(0, 5000 - (Date.now() - myWindowStart));
    await new Promise(resolve => setTimeout(resolve, waitMs));

    const finalDoc = await ref.get();
    const finalData = finalDoc.data();

    if (finalData.windowStart !== myWindowStart) {
      window.location.href = "1.html";
      return;
    }

    const finalCount = finalData.users.length;

    if (finalCount < 8) {
      window.location.href = "1.html";
    } else {
      window.location.href = "2.html";
    }
  });
</script>

</body>
</html>
