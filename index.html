<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Access Test</title>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>ã‚¢ã‚¯ã‚»ã‚¹ãƒœã‚¿ãƒ³</h1>
<button id="accessBtn">ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹</button>
<p id="status"></p>

<script>
  // Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDN0Bpaa_80Q34nc5Yfn9NzVa1OkdO6Iz0",
    authDomain: "project-5040932402734173095.firebaseapp.com",
    projectId: "project-5040932402734173095",
    storageBucket: "project-5040932402734173095.firebasestorage.app",
    messagingSenderId: "985201726384",
    appId: "1:985201726384:web:6295b669cc4a8a7626fc75"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const btn = document.getElementById("accessBtn");
  const statusEl = document.getElementById("status");

  // ç«¯æœ«ã”ã¨ã®IDï¼ˆåŒã˜ç«¯æœ«ã¯1äººæ‰±ã„ï¼‰
  let myId = localStorage.getItem("myUserId");
  if (!myId) {
    myId = Math.random().toString(36).substring(2);
    localStorage.setItem("myUserId", myId);
  }

  btn.addEventListener("click", async () => {
    btn.disabled = true;

    const ref = db.collection("access").doc("counter");
    const now = Date.now();
    let myWindowStart = null;

    // Firestore ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    await db.runTransaction(async (transaction) => {
      const doc = await transaction.get(ref);

      let windowStart;
      let users;

      if (!doc.exists) {
        windowStart = now;
        users = [myId];
      } else {
        const data = doc.data();
        windowStart = data.windowStart;
        users = data.users || [];

        if (now - windowStart >= 10000) {
          windowStart = now;
          users = [myId];
        } else {
          if (!users.includes(myId)) {
            users.push(myId);
          }
        }
      }

      myWindowStart = windowStart;

      transaction.set(ref, {
        windowStart: windowStart,
        users: users
      });
    });

    // ğŸ”¥ ã“ã“ã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’é–‹å§‹
    let remaining = Math.max(0, 10 - Math.floor((Date.now() - myWindowStart) / 1000));
    statusEl.textContent = `10ç§’ãŠå¾…ã¡ãã ã•ã„â€¦ (${remaining})`;

    const countdown = setInterval(() => {
      remaining--;
      statusEl.textContent = `10ç§’ãŠå¾…ã¡ãã ã•ã„â€¦ (${remaining})`;
      if (remaining <= 0) clearInterval(countdown);
    }, 1000);

    // å—ä»˜çµ‚äº†ã¾ã§å¾…ã¤
    const waitMs = Math.max(0, 10000 - (Date.now() - myWindowStart));
    await new Promise(resolve => setTimeout(resolve, waitMs));

    // æœ€çµ‚äººæ•°ã‚’ç¢ºèª
    const finalDoc = await ref.get();
    const finalData = finalDoc.data();

    if (finalData.windowStart !== myWindowStart) {
      window.location.href = "1.html";
      return;
    }

    const finalCount = finalData.users.length;

    if (finalCount === 1) {
      window.location.href = "1.html";
    } else {
      window.location.href = "2.html";
    }
  });
</script>

</body>
</html>
